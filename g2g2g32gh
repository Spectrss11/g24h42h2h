local httpService = game:GetService('HttpService')

local SaveManager = {}

do
    SaveManager.Folder = 'ProjectSpectre'
    SaveManager.Ignore = {}

    SaveManager.Parser = {
        Toggle = {
            Save = function(idx, object)
                return { type = 'Toggle', idx = idx, value = object.Value }
            end,
            Load = function(idx, data)
                if Toggles[idx] then
                    if data.value == false and not Toggles[idx].Value then return end
                    Toggles[idx]:SetValue(data.value)
                end
            end,
        },

        Slider = {
            Save = function(idx, object)
                return { type = 'Slider', idx = idx, value = tostring(object.Value) }
            end,
            Load = function(idx, data)
                if Options[idx] then
                    Options[idx]:SetValue(data.value)
                end
            end,
        },

        Dropdown = {
            Save = function(idx, object)
                return { type = 'Dropdown', idx = idx, value = object.Value, multi = object.Multi }
            end,
            Load = function(idx, data)
                if Options[idx] then
                    Options[idx]:SetValue(data.value)
                end
            end,
        },

        ColorPicker = {
            Save = function(idx, object)
                return {
                    type = 'ColorPicker',
                    idx = idx,
                    value = object.Value:ToHex(),
                    transparency = object.Transparency
                }
            end,
            Load = function(idx, data)
                if Options[idx] then
                    Options[idx]:SetValueRGB(Color3.fromHex(data.value), data.transparency)
                end
            end,
        },

        KeyPicker = {
            Save = function(idx, object)
                return { type = 'KeyPicker', idx = idx, mode = object.Mode, key = object.Value }
            end,
            Load = function(idx, data)
                if Options[idx] then
                    Options[idx]:SetValue({ data.key, data.mode })
                end
            end,
        },

        Input = {
            Save = function(idx, object)
                return { type = 'Input', idx = idx, text = object.Value }
            end,
            Load = function(idx, data)
                if Options[idx] and type(data.text) == 'string' then
                    Options[idx]:SetValue(data.text)
                end
            end,
        },
    }

    function SaveManager:SetIgnoreIndexes(list)
        for _, key in next, list do
            self.Ignore[key] = true
        end
    end

    function SaveManager:SetFolder(folder)
        self.Folder = folder
        self:BuildFolderTree()
    end

    function SaveManager:Save(name)
        if not name then return false, 'no config file is selected' end

        local path = self.Folder .. '/settings/' .. name .. '.json'
        local data = { objects = {} }

        for idx, toggle in next, Toggles do
            if not self.Ignore[idx] then
                table.insert(data.objects, self.Parser[toggle.Type].Save(idx, toggle))
            end
        end

        for idx, option in next, Options do
            if self.Parser[option.Type] and not self.Ignore[idx] then
                table.insert(data.objects, self.Parser[option.Type].Save(idx, option))
            end
        end

        local success, encoded = pcall(httpService.JSONEncode, httpService, data)
        if not success then return false, 'failed to encode data' end

        writefile(path, encoded)
        return true
    end

    function SaveManager:Load(name)
        if not name then return false, 'no config file is selected' end

        local path = self.Folder .. '/settings/' .. name .. '.json'
        if not isfile(path) then return false, 'invalid file' end

        local success, decoded = pcall(httpService.JSONDecode, httpService, readfile(path))
        if not success then return false, 'decode error' end

        for _, option in next, decoded.objects do
            if self.Parser[option.type] then
                self.Parser[option.type].Load(option.idx, option)
            end
        end

        return true
    end

    function SaveManager:GetAccountName()
        local player = game:GetService("Players").LocalPlayer
        return player and player.Name or "Unknown"
    end

    function SaveManager:GetAccountAutoloadPath()
        return self.Folder .. "/settings/load_acc.json"
    end

    function SaveManager:ReadAccountAutoloads()
        local path = self:GetAccountAutoloadPath()
        if not isfile(path) then return { accounts = {} } end

        local success, data = pcall(httpService.JSONDecode, httpService, readfile(path))
        if not success or type(data) ~= "table" then
            return { accounts = {} }
        end

        data.accounts = data.accounts or {}
        return data
    end

    function SaveManager:WriteAccountAutoloads(data)
        writefile(self:GetAccountAutoloadPath(), httpService:JSONEncode(data))
    end

    function SaveManager:IgnoreThemeSettings()
        self:SetIgnoreIndexes({
            "BackgroundColor",
            "MainColor",
            "AccentColor",
            "OutlineColor",
            "FontColor",
            "ThemeManager_ThemeList",
            "ThemeManager_CustomThemeList",
            "ThemeManager_CustomThemeName",
        })
    end

    function SaveManager:BuildFolderTree()
        local paths = {
            self.Folder,
            self.Folder .. '/themes',
            self.Folder .. '/settings'
        }

        for _, path in ipairs(paths) do
            if not isfolder(path) then
                makefolder(path)
            end
        end
    end

    function SaveManager:RefreshConfigList()
        local files = listfiles(self.Folder .. '/settings')
        local out = {}

        for _, file in ipairs(files) do
            if file:sub(-5) == '.json' and not file:find('load_acc.json', 1, true) then
                local name = file:match("([^/\\]+)%.json$")
                if name then
                    table.insert(out, name)
                end
            end
        end

        return out
    end

    function SaveManager:SetLibrary(library)
        self.Library = library
    end

    function SaveManager:LoadAutoloadConfig()
        local account = self:GetAccountName()

        -- account autoload
        local data = self:ReadAccountAutoloads()
        local cfg = data.accounts[account]
        if cfg then
            local ok, err = self:Load(cfg)
            if ok then
                return self.Library:Notify(('Loaded account config "%s"'):format(cfg))
            else
                return self.Library:Notify('Failed: ' .. err)
            end
        end

        -- all accounts autoload
        local path = self.Folder .. '/settings/autoload.txt'
        if isfile(path) then
            local name = readfile(path)
            local ok, err = self:Load(name)
            if ok then
                self.Library:Notify(('Loaded all accounts config "%s"'):format(name))
            else
                self.Library:Notify('Failed: ' .. err)
            end
        end
    end

    function SaveManager:BuildConfigSection(tab)
        assert(self.Library, 'SaveManager.Library not set')

        local section = tab:AddRightGroupbox('Configuration')

        section:AddDropdown('SaveManager_ConfigList', {
            Text = 'Config list',
            Values = self:RefreshConfigList(),
            AllowNull = true
        })

        section:AddInput('SaveManager_ConfigName', { Text = 'Config name' })
        section:AddDivider()

        section:AddButton('Create config', function()
            local name = Options.SaveManager_ConfigName.Value
            if name:gsub(' ', '') == '' then
                return self.Library:Notify('Invalid config name', 2)
            end
            self:Save(name)
            Options.SaveManager_ConfigList.Values = self:RefreshConfigList()
            Options.SaveManager_ConfigList:SetValues()
        end)

        section:AddButton('Load config', function()
            self:Load(Options.SaveManager_ConfigList.Value)
        end)

        section:AddButton('Overwrite config', function()
            self:Save(Options.SaveManager_ConfigList.Value)
        end)

        section:AddButton('Clear all accounts autoload', function()
            local path = self.Folder .. '/settings/autoload.txt'
            if isfile(path) then delfile(path) end
            SaveManager.AutoloadLabel:SetText('All accounts autoload: none')
        end)

        section:AddButton('Clear account autoload', function()
            local data = self:ReadAccountAutoloads()
            data.accounts[self:GetAccountName()] = nil
            self:WriteAccountAutoloads(data)
            SaveManager.AccountAutoloadLabel:SetText(self:GetAccountName() .. ' autoload: none')
        end)

        section:AddButton('Autoload for all accounts', function()
            local name = Options.SaveManager_ConfigList.Value
            writefile(self.Folder .. '/settings/autoload.txt', name)
            SaveManager.AutoloadLabel:SetText('All accounts autoload: ' .. name)
        end)

        section:AddButton('Autoload for this account', function()
            local name = Options.SaveManager_ConfigList.Value
            local data = self:ReadAccountAutoloads()
            data.accounts[self:GetAccountName()] = name
            self:WriteAccountAutoloads(data)
            SaveManager.AccountAutoloadLabel:SetText(self:GetAccountName() .. ' autoload: ' .. name)
        end)


        SaveManager.AutoloadLabel =
            section:AddLabel('All accounts autoload: none', true)

        SaveManager.AccountAutoloadLabel =
            section:AddLabel(self:GetAccountName() .. ' autoload: none', true)

        self:SetIgnoreIndexes({
            'SaveManager_ConfigList',
            'SaveManager_ConfigName'
        })
    end

    SaveManager:BuildFolderTree()
end

return SaveManager
