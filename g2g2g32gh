local HttpService = game:GetService('HttpService')

local SpectreStore = {}

do
    SpectreStore.RootFolder = 'ProjectSpectre'
    SpectreStore.IgnoreKeys = {}

    SpectreStore.Parser = {
        Toggle = {
            Save = function(idx, object)
                return { type = 'Toggle', idx = idx, value = object.Value }
            end,
            Load = function(idx, data)
                if Toggles[idx] then
                    if data.value == false and not Toggles[idx].Value then return end
                    Toggles[idx]:SetValue(data.value)
                end
            end,
        },

        Slider = {
            Save = function(idx, object)
                return { type = 'Slider', idx = idx, value = tostring(object.Value) }
            end,
            Load = function(idx, data)
                if Options[idx] then
                    Options[idx]:SetValue(data.value)
                end
            end,
        },

        Dropdown = {
            Save = function(idx, object)
                return { type = 'Dropdown', idx = idx, value = object.Value, multi = object.Multi }
            end,
            Load = function(idx, data)
                if Options[idx] then
                    Options[idx]:SetValue(data.value)
                end
            end,
        },

        ColorPicker = {
            Save = function(idx, object)
                return {
                    type = 'ColorPicker',
                    idx = idx,
                    value = object.Value:ToHex(),
                    transparency = object.Transparency
                }
            end,
            Load = function(idx, data)
                if Options[idx] then
                    Options[idx]:SetValueRGB(Color3.fromHex(data.value), data.transparency)
                end
            end,
        },

        KeyPicker = {
            Save = function(idx, object)
                return { type = 'KeyPicker', idx = idx, mode = object.Mode, key = object.Value }
            end,
            Load = function(idx, data)
                if Options[idx] then
                    Options[idx]:SetValue({ data.key, data.mode })
                end
            end,
        },

        Input = {
            Save = function(idx, object)
                return { type = 'Input', idx = idx, text = object.Value }
            end,
            Load = function(idx, data)
                if Options[idx] and type(data.text) == 'string' then
                    Options[idx]:SetValue(data.text)
                end
            end,
        },
    }


    function SpectreStore:Blacklist(list)
        for _, key in next, list do
            self.IgnoreKeys[key] = true
        end
    end

    function SpectreStore:SetRoot(folder)
        self.RootFolder = folder
        self:InitFolders()
    end

    function SpectreStore:InitFolders()
        for _, path in ipairs({
            self.RootFolder,
            self.RootFolder .. '/themes',
            self.RootFolder .. '/settings'
        }) do
            if not isfolder(path) then
                makefolder(path)
            end
        end
    end


    function SpectreStore:Write(name)
        if not name then return false, 'no config selected' end

        local data = { objects = {} }
        local path = self.RootFolder .. '/settings/' .. name .. '.json'

        for idx, toggle in next, Toggles do
            if not self.IgnoreKeys[idx] then
                table.insert(data.objects, self.Parser[toggle.Type].Save(idx, toggle))
            end
        end

        for idx, option in next, Options do
            if self.Parser[option.Type] and not self.IgnoreKeys[idx] then
                table.insert(data.objects, self.Parser[option.Type].Save(idx, option))
            end
        end

        writefile(path, HttpService:JSONEncode(data))
        return true
    end

    function SpectreStore:Apply(name)
        if not name then return false end

        local path = self.RootFolder .. '/settings/' .. name .. '.json'
        if not isfile(path) then return false end

        local decoded = HttpService:JSONDecode(readfile(path))
        for _, obj in next, decoded.objects do
            if self.Parser[obj.type] then
                self.Parser[obj.type].Load(obj.idx, obj)
            end
        end

        return true
    end


    function SpectreStore:GetAccount()
        local plr = game:GetService("Players").LocalPlayer
        return plr and plr.Name or "Unknown"
    end

    function SpectreStore:GetAccountFile()
        return self.RootFolder .. "/settings/load_acc.json"
    end

    function SpectreStore:ReadAccounts()
        local path = self:GetAccountFile()
        if not isfile(path) then return { accounts = {} } end
        return HttpService:JSONDecode(readfile(path))
    end

    function SpectreStore:WriteAccounts(data)
        writefile(self:GetAccountFile(), HttpService:JSONEncode(data))
    end

    function SpectreStore:AutoApply()
        local acc = self:GetAccount()
        local data = self:ReadAccounts()

        if data.accounts and data.accounts[acc] then
            return self:Apply(data.accounts[acc])
        end

        local global = self.RootFolder .. '/settings/autoload.txt'
        if isfile(global) then
            self:Apply(readfile(global))
        end
    end
    function SpectreStore:Scan()
        local out = {}
        for _, file in ipairs(listfiles(self.RootFolder .. '/settings')) do
            local name = file:match("([^/\\]+)%.json$")
            if name then table.insert(out, name) end
        end
        return out
    end

    function SpectreStore:BuildUI(tab)
        local section = tab:AddRightGroupbox('Configuration')

        section:AddDropdown('Spectre_ConfigList', {
            Text = 'Config list',
            Values = self:Scan(),
            AllowNull = true
        })

        section:AddInput('Spectre_ConfigName', { Text = 'Config name' })
        section:AddDivider()

        section:AddButton('Create config', function()
            local name = Options.Spectre_ConfigName.Value
            if name:gsub(' ', '') == '' then return end
            self:Write(name)
        end)

        section:AddButton('Load config', function()
            self:Apply(Options.Spectre_ConfigList.Value)
        end)

        section:AddButton('Overwrite config', function()
            self:Write(Options.Spectre_ConfigList.Value)
        end)

        section:AddButton('Autoload for all accounts', function()
            writefile(self.RootFolder .. '/settings/autoload.txt', Options.Spectre_ConfigList.Value)
        end)

        section:AddButton('Autoload for this account', function()
            local data = self:ReadAccounts()
            data.accounts = data.accounts or {}
            data.accounts[self:GetAccount()] = Options.Spectre_ConfigList.Value
            self:WriteAccounts(data)
        end)

        self:Blacklist({
            'Spectre_ConfigList',
            'Spectre_ConfigName'
        })
    end

    SpectreStore:InitFolders()
end

return SpectreStore
