local HttpService = game:GetService('HttpService')

local SpectreConfig = {}

do
    SpectreConfig.Root = 'ProjectSpectre'
    SpectreConfig.Blacklist = {}

    SpectreConfig.Serializers = {

        Toggle = {
            Encode = function(id, obj)
                return { t = 'Toggle', id = id, v = obj.Value }
            end,
            Decode = function(id, data)
                if Toggles[id] then
                    if data.v == false and not Toggles[id].Value then return end
                    Toggles[id]:SetValue(data.v)
                end
            end
        },

        Slider = {
            Encode = function(id, obj)
                return { t = 'Slider', id = id, v = tostring(obj.Value) }
            end,
            Decode = function(id, data)
                if Options[id] then
                    Options[id]:SetValue(data.v)
                end
            end
        },

        Dropdown = {
            Encode = function(id, obj)
                return { t = 'Dropdown', id = id, v = obj.Value, m = obj.Multi }
            end,
            Decode = function(id, data)
                if Options[id] then
                    Options[id]:SetValue(data.v)
                end
            end
        },

        ColorPicker = {
            Encode = function(id, obj)
                return {
                    t = 'ColorPicker',
                    id = id,
                    v = obj.Value:ToHex(),
                    a = obj.Transparency
                }
            end,
            Decode = function(id, data)
                if Options[id] then
                    Options[id]:SetValueRGB(Color3.fromHex(data.v), data.a)
                end
            end
        },

        KeyPicker = {
            Encode = function(id, obj)
                return { t = 'KeyPicker', id = id, k = obj.Value, m = obj.Mode }
            end,
            Decode = function(id, data)
                if Options[id] then
                    Options[id]:SetValue({ data.k, data.m })
                end
            end
        },

        Input = {
            Encode = function(id, obj)
                return { t = 'Input', id = id, v = obj.Value }
            end,
            Decode = function(id, data)
                if Options[id] and type(data.v) == 'string' then
                    Options[id]:SetValue(data.v)
                end
            end
        }
    }

    -- =========================
    -- INTERNAL
    -- =========================

    function SpectreConfig:BlacklistKeys(list)
        for _, k in next, list do
            self.Blacklist[k] = true
        end
    end

    function SpectreConfig:InitStorage()
        for _, p in ipairs({
            self.Root,
            self.Root .. '/themes',
            self.Root .. '/settings'
        }) do
            if not isfolder(p) then
                makefolder(p)
            end
        end
    end

    function SpectreConfig:WriteConfig(name)
        if not name then return false, 'no name' end

        local payload = { entries = {} }
        local path = self.Root .. '/settings/' .. name .. '.json'

        for id, t in next, Toggles do
            if not self.Blacklist[id] then
                table.insert(payload.entries, self.Serializers[t.Type].Encode(id, t))
            end
        end

        for id, o in next, Options do
            local ser = self.Serializers[o.Type]
            if ser and not self.Blacklist[id] then
                table.insert(payload.entries, ser.Encode(id, o))
            end
        end

        writefile(path, HttpService:JSONEncode(payload))
        return true
    end

    function SpectreConfig:ApplyConfig(name)
        if not name then return false end

        local path = self.Root .. '/settings/' .. name .. '.json'
        if not isfile(path) then return false end

        local data = HttpService:JSONDecode(readfile(path))
        for _, entry in ipairs(data.entries or {}) do
            local handler = self.Serializers[entry.t]
            if handler then
                handler.Decode(entry.id, entry)
            end
        end

        return true
    end

    function SpectreConfig:GetPlayerKey()
        return game:GetService("Players").LocalPlayer.Name
    end

    function SpectreConfig:GetAccountMapPath()
        return self.Root .. '/settings/accounts.json'
    end

    function SpectreConfig:ReadAccountMap()
        if not isfile(self:GetAccountMapPath()) then
            return {}
        end
        return HttpService:JSONDecode(readfile(self:GetAccountMapPath()))
    end

    function SpectreConfig:WriteAccountMap(map)
        writefile(self:GetAccountMapPath(), HttpService:JSONEncode(map))
    end

    function SpectreConfig:ApplyAutoConfig()
        local acc = self:GetPlayerKey()
        local map = self:ReadAccountMap()

        if map[acc] then
            return self:ApplyConfig(map[acc])
        end

        local global = self.Root .. '/settings/autoload.txt'
        if isfile(global) then
            self:ApplyConfig(readfile(global))
        end
    end

    function SpectreConfig:ScanConfigs()
        local out = {}
        for _, f in ipairs(listfiles(self.Root .. '/settings')) do
            local name = f:match("([^/\\]+)%.json$")
            if name then table.insert(out, name) end
        end
        return out
    end

    function SpectreConfig:CreateConfigUI(tab)
        local box = tab:AddRightGroupbox('Configuration')

        box:AddDropdown('Spectre_ConfigList', {
            Values = self:ScanConfigs(),
            AllowNull = true
        })

        box:AddInput('Spectre_ConfigName', { Text = 'Config name' })
        box:AddDivider()

        box:AddButton('Create', function()
            self:WriteConfig(Options.Spectre_ConfigName.Value)
        end)

        box:AddButton('Load', function()
            self:ApplyConfig(Options.Spectre_ConfigList.Value)
        end)

        box:AddButton('Overwrite', function()
            self:WriteConfig(Options.Spectre_ConfigList.Value)
        end)

        box:AddButton('Autoload (All Accounts)', function()
            writefile(self.Root .. '/settings/autoload.txt', Options.Spectre_ConfigList.Value)
        end)

        box:AddButton('Autoload (This Account)', function()
            local map = self:ReadAccountMap()
            map[self:GetPlayerKey()] = Options.Spectre_ConfigList.Value
            self:WriteAccountMap(map)
        end)

        self:BlacklistKeys({
            'Spectre_ConfigList',
            'Spectre_ConfigName'
        })
    end

    SpectreConfig:InitStorage()
end

return SpectreConfig
